@using CSM.Common.Resources
@using CSM.Common.Utilities
@using MvcPaging
@model CSM.Web.Models.LookupCustomerViewModel

@helper LabelForSort(string headerText, string fieldName, string sortField, string sortOrder)
{
    <a href="javascript:;" onclick="sortField('@fieldName');return false;">
        @headerText
        @if (fieldName.ToLower().Equals(sortField.ToLower()))
        {
            if (sortOrder.Equals("ASC"))
            {<i class="fa fa-sort-asc"></i>}
            else
            {<i class="fa fa-sort-desc"></i> }
        }
        else
        {<i class="fa fa-sort"></i>}
    </a>
}

<hr class="dashed-line clear" />
@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="form-inline nopadding">
        <div class="pull-right" id="dvServiceMsg">
            <span class='badge badge-warning'>@ViewBag.ErrorMessage</span>
        </div>
        <div class="clear"></div>
    </div>
}

@if (Model.CustomerSearchFilter.TotalRecords == 0)
{
    string sortField = Model.CustomerSearchFilter.SortField;
    string sortOrder = Model.CustomerSearchFilter.SortOrder;

    <div class="table-responsive margin-top-10">
        <table class="table table-hover datatable">
            <thead>
                <tr>
                    @*<th>Action</th>
                    <th>CIF ID</th>
                    <th>ชื่อจริง <br />ลูกค้า</th>
                    <th>นามสกุล<br />ลูกค้า</th>
                    <th title="เลขที่บัตรประชาชน/นิติบุุคคล/Passport/Employee No.">ID Number</th>
                    <th>ประเภทบัตร</th>
                    <th>ประเภทลูกค้า</th>
                    <th>Customer Type</th>
                    <th>Product</th>*@
                    <th>Action</th>
                    <th>CIF ID</th>
                    <th>Product</th>
                    <th title="เลขที่บัตรประชาชน/นิติบุุคคล/Passport/Employee No.">ID Number</th>
                    <th>ชื่อลูกค้า</th>
                    <th>นามสกุล<br />ลูกค้า</th>
                    <th>เลขที่บัญชี<br />/สัญญา</th>
                    <th>ทะเบียน<br />รถยนต์</th>
                    <th>เบอร์โทรศัพท์</th>
                    <th>สถานะบัญชี<br />/สัญญา</th>
                    <th>สาขา</th>
                    <th>ประเภทลูกค้า</th>
                    <th>ID Type</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="13" class="center">@Resource.Msg_NoRecords</td>
                </tr>
            </tbody>
        </table>
    </div>
}
else
{
    string sortField = Model.CustomerSearchFilter.SortField;
    string sortOrder = Model.CustomerSearchFilter.SortOrder;

    <div class="form-inline nopadding">
        <div class="form-group">
            @Html.Raw(Html.Pager(
                new Options
                {
                    PageSize = Model.CustomerSearchFilter.PageSize,
                    TotalItemCount = Model.CustomerSearchFilter.TotalRecords,
                    CurrentPage = Model.CustomerSearchFilter.PageNo,
                    ItemTexts = new ItemTexts
                    {
                        First = "<i class='fa fa-step-backward' style='font-size: 0.8em'></i>",
                        Previous = "<i class='fa fa-caret-left'></i>",
                        Next = "<i class='fa fa-caret-right'></i>",
                        Last = "<i class='fa fa-step-forward' style='font-size: 0.8em'></i>"
                    },
                    IsShowFirstLast = true,
                    CssClass = "pager",
                    IsShowInputPage = true
                },
                new { PageSize = ViewBag.PageSize }))
        </div>
        <div class="form-group">
            @Html.DropDownList("PageSize", new SelectList(new Dictionary<string, int> { { "15", 15 }, { "30", 30 } }, "Key", "Value"), new { @class = "form-control input-xs", id = "pagesizelist" })
        </div>
        <div class="form-group text-nowrap margin-left-8">
            <strong>
                @MvcHtmlString.Create(string.Format(Resource.Lbl_Paging, @Model.CustomerSearchFilter.FirstPageIndex, @Model.CustomerSearchFilter.LastPageIndex, @Model.CustomerSearchFilter.TotalRecords))
            </strong>
        </div>
    </div>
    <div class="clearfix"></div>
    <div class="table-responsive margin-top-10 sr">
        <table class="table table-hover datatable">
            <thead>
                <tr>
                    @*<th>Action</th>
                    <th>CIF ID</th>
                    <th>ชื่อจริง <br />ลูกค้า</th>
                    <th>นามสกุล<br />ลูกค้า</th>
                    <th title="เลขที่บัตรประชาชน/นิติบุุคคล/Passport/Employee No.">ID Number</th>
                    <th>ประเภทบัตร</th>
                    <th>ประเภทลูกค้า</th>
                    <th>Customer Type</th>
                    <th>Product</th>*@
                    <th>Action</th>
                    <th>CIF ID</th>
                    <th>Product</th>
                    <th title="เลขที่บัตรประชาชน/นิติบุุคคล/Passport/Employee No.">ID Number</th>
                    <th>ชื่อลูกค้า</th>
                    <th>นามสกุล<br />ลูกค้า</th>
                    <th>เลขที่บัญชี<br />/สัญญา</th>
                    <th>ทะเบียน<br />รถยนต์</th>
                    <th>เบอร์โทรศัพท์</th>
                    <th>สถานะบัญชี<br />/สัญญา</th>
                    <th>สาขา</th>
                    <th>ประเภทลูกค้า</th>
                    <th>ID Type</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.CustomerTableList)
                {
                    var custNo = item.CustomerNo ?? 0;
                    var cbsCardTypeCode = (item.CardType == null ? "" : item.CardType.CardTypeCode);
                    var cbsCardTypeName = (item.CardType == null ? item.CardTypeName : item.CardType.CardTypeName);
                    var titleTh = (item.TitleTH == null ? "" : item.TitleTH.TitleName);
                    var titleEn = (item.TitleEN == null ? "" : item.TitleEN.TitleName);
                    var birthDate = item.BirthDateDisplay;
                    var cardNo = item.CardNo ?? "";
                    var custFNameTh = item.CustomerFirstNameTh ?? "";
                    var custLNameTh = item.CustomerLastNameTh ?? "";
                    var custFNameEn = item.CustomerFirstNameEn ?? "";
                    var custLNameEn = item.CustomerLastNameEn ?? "";
                    var empCode = item.EmployeeCode ?? "";
                    var custType = item.CustomerType.ToString();
                    string acctStatusName = string.Empty;
                    int accStatusId = 0;
                    using (var facade = new CSM.Business.CommonFacade())
                    {
                        long accStat;
                        CSM.Entity.AccountStatusEntity accEnt;
                        if (long.TryParse(item.AccountStatus, out accStat))
                        {
                            accEnt = facade.GetConfigAccountStatus(accStat);
                            accStatusId = accEnt.AccountStatusId.Value;
                            acctStatusName = accEnt.AccountStatusName;
                        }
                        else
                        {
                            acctStatusName = Constants.AccountStatus.GetMessage(item.AccountStatus);
                        }
                    }
                    /*
                     * 0 = customerId, 1 = customerNumber, 2 = CustomerType, 3 = CustomerSubscriptionTypeCode, 4 = CustomerSubscriptionName, 5 = CustomerCardNo, 6 = CustomerBirthDate
                        , 7 = CustomerTitleTh, 8 = CustomerFirstNameTh, 9 = CustomerLastNameTh, 10 = CustomerTitleEn, 11 = CustomerFirstNameEn, 12 = CustomerLastNameEn, 13 = CustomerEmployeeCode
                        , 14 = AccountId, 15 = AccountNo, 16 = AccountStatus, 17 = ProductGroup, 18 = Product, 19 = BranchName, 20 = CarNo
                     */
                    var onSelectClick = string.Format("onSelectCustomerClick('{0}', '{1}', '{2}','{3}', '{4}', '{5}','{6}'"
                        + ",'{7}', '{8}','{9}','{10}', '{11}', '{12}', '{13}'"
                        + ", '{14}', '{15}', '{16}', '{17}', '{18}', '{19}', '{20}','{21}')"
                        , item.CustomerId, custNo, custType, cbsCardTypeCode, cbsCardTypeName,  cardNo, birthDate
                        , titleTh, HttpUtility.HtmlEncode(custFNameTh), HttpUtility.HtmlEncode(custLNameTh), titleEn, HttpUtility.HtmlEncode(custFNameEn), HttpUtility.HtmlEncode(custLNameEn), empCode
                        , item.AccountId, item.AccountNo, acctStatusName, accStatusId.ToString(), "", item.ProductName, item.BranchName, item.CarNo);
                <tr>
                    <td class="center">
                        <a href='javascript:;' class='btn btn-success btn-xs' onclick='@onSelectClick'>เลือก</a>
                    </td>
                    <td>@item.CustomerNo.ToDisplay()</td>
                    <td>@item.ProductName</td>
                    <td>@item.CardNo</td>
                    <td>@item.CustomerFirstName</td>
                    <td>@item.CustomerLastName</td>
                    <td>@item.AccountNo</td>
                    <td>@item.CarNo</td>
                    <td>@item.PhoneNo</td>
                    <td>@acctStatusName</td>
                    <td>@item.BranchName</td>
                    <td>@Constants.CustomerType.GetMessage(item.CustomerType)</td>
                    <td>@item.CardTypeName</td>
                </tr>
                }
            </tbody>
        </table>
    </div>
}
